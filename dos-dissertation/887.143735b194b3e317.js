"use strict";(self.webpackChunkdos_dissertation=self.webpackChunkdos_dissertation||[]).push([[887],{5887:(Q,_,u)=>{u.r(_),u.d(_,{EditorModule:()=>$});var h=u(9808),f=u(3075),T=u(1083),m=u(4831),M=u(4704),x=u(5861),C=u(8746),y=u(136),D=u(394),e=u(5e3),b=u(7423);let Z=(()=>{class a{constructor(){this.control=new m.M_(null)}ngOnInit(){var t;null!==(t=this.modalChildData)&&void 0!==t&&t.name&&this.control.setValue(this.modalChildData.name)}onKeyUp(t){switch(t.code){case"Enter":this.onApply();break;case"Escape":this.onClose()}}onApply(){var t;null===(t=this.dialogRef)||void 0===t||t.close({name:this.control.value})}onClose(){var t;null===(t=this.dialogRef)||void 0===t||t.close(null)}}return a.\u0275fac=function(t){return new(t||a)},a.\u0275cmp=e.Xpm({type:a,selectors:[["app-editor-name-modal"]],decls:7,vars:1,consts:[[1,"inside-modal-body-container"],[3,"formControl","keyUpEvent"],[1,"footer-buttons"],["mat-raised-button","","color","success",3,"click"],["mat-raised-button","","color","accent",3,"click"]],template:function(t,o){1&t&&(e.TgZ(0,"div",0)(1,"uf-input",1),e.NdJ("keyUpEvent",function(i){return o.onKeyUp(i)}),e.qZA()(),e.TgZ(2,"div",2)(3,"button",3),e.NdJ("click",function(){return o.onApply()}),e._uU(4," \u041f\u0440\u0438\u043c\u0435\u043d\u0438\u0442\u044c "),e.qZA(),e.TgZ(5,"button",4),e.NdJ("click",function(){return o.onClose()}),e._uU(6,"\u0417\u0430\u043a\u0440\u044b\u0442\u044c"),e.qZA()()),2&t&&(e.xp6(1),e.Q6J("formControl",o.control))},dependencies:[f.JJ,f.oH,b.lW,m.Oy],styles:["[_nghost-%COMP%]{display:flex;flex-direction:column}"]}),a})();function E(a,r){if(1&a&&(e.ynx(0),e.TgZ(1,"div",5),e._uU(2),e.qZA(),e.TgZ(3,"div"),e._uU(4),e.qZA(),e.BQk()),2&a){const t=r.$implicit;e.xp6(2),e.hij("",t.title,":"),e.xp6(2),e.Oqu(t.value)}}let S=(()=>{class a{constructor(){this.properties=[]}ngOnInit(){var t;if(null!==(t=this.modalChildData)&&void 0!==t&&t.data&&this.modalChildData.data.table){const o=[];Object.keys(this.modalChildData.data.table).forEach(n=>{o.push({title:n,value:this.modalChildData.data.table[n]})}),this.properties=[...o]}}onClose(){var t;null===(t=this.dialogRef)||void 0===t||t.close(null)}}return a.\u0275fac=function(t){return new(t||a)},a.\u0275cmp=e.Xpm({type:a,selectors:[["app-editor-properties-modal"]],decls:6,vars:1,consts:[[1,"inside-modal-body-container"],[1,"container"],[4,"ngFor","ngForOf"],[1,"footer-buttons"],["mat-raised-button","","color","accent",3,"click"],[1,"title"]],template:function(t,o){1&t&&(e.TgZ(0,"div",0)(1,"div",1),e.YNc(2,E,5,2,"ng-container",2),e.qZA()(),e.TgZ(3,"div",3)(4,"button",4),e.NdJ("click",function(){return o.onClose()}),e._uU(5,"\u0417\u0430\u043a\u0440\u044b\u0442\u044c"),e.qZA()()),2&t&&(e.xp6(2),e.Q6J("ngForOf",o.properties))},dependencies:[h.sg,b.lW],styles:["[_nghost-%COMP%]{display:flex;flex-direction:column}.container[_ngcontent-%COMP%]{display:grid;grid-auto-flow:row dense;grid-template-columns:auto 1fr;gap:5px 5px}.container[_ngcontent-%COMP%]   .title[_ngcontent-%COMP%]{font-weight:700;text-align:right}"]}),a})(),B=(()=>{class a{onApply(){var t;null===(t=this.dialogRef)||void 0===t||t.close({create:!0})}onClose(){var t;null===(t=this.dialogRef)||void 0===t||t.close(null)}}return a.\u0275fac=function(t){return new(t||a)},a.\u0275cmp=e.Xpm({type:a,selectors:[["app-editor-create-db"]],decls:7,vars:0,consts:[[1,"inside-modal-body-container"],[1,"footer-buttons"],["mat-raised-button","","color","success",3,"click"],["mat-raised-button","","color","accent",3,"click"]],template:function(t,o){1&t&&(e.TgZ(0,"div",0),e._uU(1," \u0423 \u0432\u0430\u0441 \u043d\u0435\u0442 \u043f\u0440\u043e\u0435\u043a\u0442\u0430 \u0434\u043b\u044f \u0440\u0435\u0434\u0430\u043a\u0442\u0438\u0440\u043e\u0432\u0430\u043d\u0438\u044f. \u0425\u043e\u0442\u0438\u0442\u0435 \u0441\u043e\u0437\u0434\u0430\u0442\u044c \u043d\u043e\u0432\u044b\u0439 \u043f\u0440\u043e\u0435\u043a\u0442?\n"),e.qZA(),e.TgZ(2,"div",1)(3,"button",2),e.NdJ("click",function(){return o.onApply()}),e._uU(4," \u0421\u043e\u0437\u0434\u0430\u0442\u044c \u043d\u043e\u0432\u044b\u0439 \u043f\u0440\u043e\u0435\u043a\u0442 "),e.qZA(),e.TgZ(5,"button",3),e.NdJ("click",function(){return o.onClose()}),e._uU(6,"\u041e\u0442\u043c\u0435\u043d\u0430"),e.qZA()())},dependencies:[b.lW],styles:["[_nghost-%COMP%]{display:flex;flex-direction:column}"]}),a})();var O=u(2313),L=u(520),p=u(8306);let A=(()=>{class a{constructor(){this.dbVersion=1,this.dbName="My DB",this.dbTables=[],this.dbExists=!0}updateData(t,o){return new p.y(n=>{this.openDB().subscribe(i=>{const s=i.transaction([t],"readwrite");s.oncomplete=()=>{n.next(),n.complete()},s.objectStore(t).put(o),i.close()},i=>{n.error(i)})})}getData(t,o){return new p.y(n=>{this.openDB().subscribe(i=>{i.transaction(t,"readwrite").objectStore(t).get(Number(o)).onsuccess=c=>{i.close(),n.next(c.target.result),n.complete()}},i=>{n.error(i)})})}removeData(t,o){return new p.y(n=>{this.openDB().subscribe(i=>{const s=i.transaction(t,"readwrite"),l=s.objectStore(t);s.oncomplete=()=>{n.next(),n.complete()},l.delete(o).onsuccess=()=>{i.close()}},i=>{n.error(i)})})}insertData(t,o){return new p.y(n=>{this.openDB().subscribe(i=>{let s=0;const l=i.transaction([t],"readwrite");l.oncomplete=()=>{n.next(s),n.complete()},l.objectStore(t).add(o).onsuccess=v=>{var g;s=null===(g=v.target)||void 0===g?void 0:g.result},i.close()},i=>{n.error(i)})})}getRowList(t,o=["id","name"]){return new p.y(n=>{const i=[];this.openDB().subscribe(s=>{const l=s.transaction(t),c=l.objectStore(t);l.onerror=d=>n.error(d),l.oncomplete=()=>{n.next(i.map(d=>{const v={};return o.forEach(g=>{v[g]=d[g]}),v})),n.complete()},c.getAll().onsuccess=d=>{d.target.result&&i.push(...d.target.result),s.close()}},s=>{n.error(s)})})}openDB(){return new p.y(t=>{this.dbExists=!0;const o=indexedDB.open(this.dbName,this.dbVersion);o.onerror=n=>{t.error(n.target.message)},o.onblocked=()=>t.error("\u0411\u0430\u0437\u0430 \u0437\u0430\u0431\u043b\u043e\u043a\u0438\u0440\u043e\u0432\u0430\u043d\u0430"),o.onupgradeneeded=n=>{this.dbExists=!1;const i=n.target.result;this.dbTables.forEach(s=>{i.objectStoreNames.contains(s)||i.createObjectStore(s,{keyPath:"id",autoIncrement:!0})})},o.onsuccess=n=>{t.next(n.target.result),t.complete()}})}}return a.\u0275fac=function(t){return new(t||a)},a.\u0275prov=e.Yz7({token:a,factory:a.\u0275fac,providedIn:"root"}),a})(),k=(()=>{class a extends A{constructor(){super(...arguments),this.dbVersion=1,this.dbName=`${y.X} DB`,this.dbTables=["layers"],this.table="layers"}get hasDbExists(){return this.dbExists}removeLayer(t){return this.removeData(this.table,t)}loadLayer(t){return this.getData(this.table,t)}saveLayer(t,o,n,i=null){return new p.y(s=>{t?this.loadLayer(t).subscribe(l=>{const c=Object.assign(l,i?{id:t,name:o,visible:n,geoData:i}:{id:t,name:o,visible:n});this.updateData(this.table,c).subscribe(()=>{s.next(t),s.complete()})}):this.insertData(this.table,{name:o,visible:n,geoData:i}).subscribe(l=>{s.next(l),s.complete()})})}getLayersList(t=["id","name","visible","geoData"]){return this.getRowList(this.table,t)}}return a.\u0275fac=function(){let r;return function(o){return(r||(r=e.n5z(a)))(o||a)}}(),a.\u0275prov=e.Yz7({token:a,factory:a.\u0275fac,providedIn:"root"}),a})();var J=u(4125),w=u(5245),F=u(7238);function j(a,r){1&a&&(e.TgZ(0,"div",10),e._UZ(1,"div",11),e.qZA())}function N(a,r){1&a&&(e.TgZ(0,"div",12),e._uU(1," \u041d\u0435\u0442 \u0434\u043e\u0441\u0442\u0443\u043f\u043d\u044b\u0445 \u0441\u043b\u043e\u0435\u0432 "),e.qZA())}function P(a,r){if(1&a){const t=e.EpF();e.TgZ(0,"div",16)(1,"button",17),e.NdJ("click",function(){const i=e.CHM(t).$implicit,s=e.oxw(2);return e.KtG(s.onLayerSwitchVisibility(i))}),e.TgZ(2,"mat-icon"),e._uU(3),e.qZA()(),e.TgZ(4,"div",18),e.NdJ("dblclick",function(){const i=e.CHM(t).$implicit,s=e.oxw(2);return e.KtG(s.onLayerEditName(i))}),e._uU(5),e.qZA(),e.TgZ(6,"button",19),e.NdJ("click",function(){const i=e.CHM(t).$implicit,s=e.oxw(2);return e.KtG(s.onLayerEditName(i))}),e.TgZ(7,"mat-icon"),e._uU(8,"edit"),e.qZA()(),e.TgZ(9,"button",20),e.NdJ("click",function(){const i=e.CHM(t).$implicit,s=e.oxw(2);return e.KtG(s.onSaveLayer(i))}),e.TgZ(10,"mat-icon"),e._uU(11,"save"),e.qZA()(),e.TgZ(12,"button",21),e.NdJ("click",function(){const i=e.CHM(t).$implicit,s=e.oxw(2);return e.KtG(s.onLayerRemove(i))}),e.TgZ(13,"mat-icon"),e._uU(14,"delete"),e.qZA()(),e.TgZ(15,"button",22),e.NdJ("click",function(){const i=e.CHM(t).$implicit,s=e.oxw(2);return e.KtG(s.onLayerExport(i))}),e.TgZ(16,"mat-icon"),e._uU(17,"file_download"),e.qZA()()()}if(2&a){const t=r.$implicit,o=e.oxw(2);e.ekj("selected",t.selected),e.xp6(1),e.Q6J("disabled",o.editingMode),e.xp6(2),e.Oqu(t.visible?"visibility":"visibility_off"),e.xp6(2),e.hij(" ",t.name," "),e.xp6(1),e.Q6J("disabled",o.editingMode),e.xp6(3),e.Q6J("disabled",!t.changed||o.editingMode),e.xp6(3),e.Q6J("disabled",o.editingMode),e.xp6(3),e.Q6J("disabled",t.changed||o.editingMode)}}function H(a,r){if(1&a&&(e.TgZ(0,"div",13)(1,"div",14),e.YNc(2,P,18,9,"div",15),e.qZA()()),2&a){const t=e.oxw();e.xp6(2),e.Q6J("ngForOf",t.layers)}}const U=[{path:"",component:(()=>{class a{constructor(t,o,n,i,s){this.ngZone=o,this.httpClient=n,this.dialogService=i,this.layersDBService=s,this.loading=!0,this.layers=[],this.mapLayers=[],this.editingMode=!1,t.setTitle(`\u0420\u0435\u0434\u0430\u043a\u0442\u043e\u0440 | ${y.X}`)}ngOnInit(){this.loadLayers()}onObjectChangedEvent(t){this.ngZone.run(()=>{if(this.editingMode=!1,t){const o=this.layers.find(n=>n.id===t.data.layer);if(o){const n=o.geoData.features.find(i=>i.id===t.data.id);n&&(o.changed=!0,n.geometry.coordinates=[...t.coordinates])}}this.layers.forEach(o=>o.selected=!1)})}onObjectSelectedEvent(t){if("editable"===t.type)this.ngZone.run(()=>{this.editingMode=!0,this.layers.forEach(o=>o.selected=o.id===t.layer)});else{const o=this.layers.find(n=>n.id===t.layer);if(o){const n=o.geoData.features.find(i=>i.id===t.id);n&&this.ngZone.run(()=>{this.dialogService.showModal(`${o.name} obj#${n.id}`,S,{data:n.properties.data}).subscribe()})}}}onSaveLayer(t){this.dialogService.showWait("\u0421\u043e\u0445\u0440\u0430\u043d\u0435\u043d\u0438\u0435 \u0441\u043b\u043e\u044f..."),this.layersDBService.saveLayer(t.id,t.name,t.visible,t.geoData).pipe((0,C.x)(()=>this.dialogService.hideWait())).subscribe(()=>{t.changed=!1})}onLayerRemove(t){!t.id||this.dialogService.showConfirm('<div>\u0412\u044b \u0434\u0435\u0439\u0441\u0442\u0432\u0438\u0442\u0435\u043b\u044c\u043d\u043e \u0445\u043e\u0442\u0438\u0442\u0435 \u0443\u0434\u0430\u043b\u0438\u0442\u044c \u044d\u0442\u043e\u0442 \u0441\u043b\u043e\u0439?</div>\n        <div class="text-center text-danger">\u042d\u0442\u043e \u0434\u0435\u0439\u0441\u0442\u0432\u0438\u0435 \u043d\u0435\u043e\u0431\u0440\u0430\u0442\u0438\u043c\u043e!</div>').subscribe(()=>{t.id&&this.layersDBService.removeLayer(t.id).subscribe(()=>{this.loadLayers()})})}onLayerExport(t){this.dialogService.showWait("\u042d\u043a\u0441\u043f\u043e\u0440\u0442 \u0441\u043b\u043e\u044f..."),this.layersDBService.loadLayer(t.id).pipe((0,C.x)(()=>this.dialogService.hideWait())).subscribe(o=>{const n={type:o.geoData.type,name:o.name,features:o.geoData.features.map(i=>({type:i.type,properties:i.properties,geometry:i.geometry}))};m.ZH.downloadJson(n,`${o.name}.json`)})}onLayerEditName(t){t.selected||this.dialogService.showModal("\u0423\u043a\u0430\u0436\u0438\u0442\u0435 \u043d\u0430\u0438\u043c\u0435\u043d\u043e\u0432\u0430\u043d\u0438\u0435 \u0441\u043b\u043e\u044f",Z,{name:t.name},!0,"",!0).subscribe(o=>{null!=o&&o.name&&(t.name=o.name,t.changed=!0)})}onLayerSwitchVisibility(t){t.changed=!0,t.visible=!t.visible,this.updateMapLayers()}onOpenGeoJsonFile(){m.ZH.uploadJson().subscribe(t=>{const o=D.k.openGeoJsonFile(t);this.layersDBService.saveLayer(null,t.name,!0,o).subscribe(()=>{this.loadLayers()},n=>{this.loading=!1,this.dialogService.showToastError(n.message)})})}loadLayers(){this.loading=!0,this.layersDBService.getLayersList().pipe((0,C.x)(()=>this.loading=!1)).subscribe(t=>{this.layersDBService.hasDbExists?(this.layers=(t||[]).map(o=>({id:o.id,name:o.name,visible:o.visible,selected:!1,changed:!1,geoData:Object.assign({id:o.id},o.geoData)})),this.updateMapLayers()):setTimeout(()=>this.createDB())})}updateMapLayers(){this.mapLayers=this.layers.map(t=>({id:t.id,visible:t.visible,features:t.geoData.features.map(o=>({id:o.id,name:t.name,geometry:o.geometry,properties:{data:{id:o.id,layer:t.id}}}))}))}createDB(){this.loading=!1,this.dialogService.showModal("\u0421\u043e\u0437\u0434\u0430\u043d\u0438\u0435 \u043f\u0440\u043e\u0435\u043a\u0442\u0430",B,null,!1,"",!0).subscribe(t=>{t&&(this.dialogService.showWait("\u0421\u043e\u0437\u0434\u0430\u043d\u0438\u0435 \u043f\u0440\u043e\u0435\u043a\u0442\u0430..."),this.httpClient.get(y.O+"/layers.json").subscribe(o=>{this.createDBLayers(o).then(()=>{this.dialogService.hideWait(),this.loadLayers()})}))})}createDBLayers(t){var o=this;return(0,x.Z)(function*(){if(Array.isArray(t))for(const n of t)yield o.loadLayerFromFile(n)})()}loadLayerFromFile(t){var o=this;return(0,x.Z)(function*(){return new Promise((n,i)=>{o.httpClient.get(`${y.O}/${t.file}`).subscribe(s=>{const l=D.k.openGeoJsonFile(s);o.layersDBService.saveLayer(null,s.name,!0,l).subscribe(()=>{n()},c=>{i(c)})},s=>i(s))})})()}}return a.\u0275fac=function(t){return new(t||a)(e.Y36(O.Dx),e.Y36(e.R0b),e.Y36(L.eN),e.Y36(m.xA),e.Y36(k))},a.\u0275cmp=e.Xpm({type:a,selectors:[["app-editor-home"]],decls:16,vars:6,consts:[[1,"flex-row","flex-auto"],[1,"flex-col","flex-auto"],[3,"layers","editable","objectSelectedEvent","objectChangedEvent"],[1,"layers-manager"],[1,"title"],["class","loading-block",4,"ngIf"],["class","no-layers",4,"ngIf"],["class","scroll-container",4,"ngIf"],[1,"toolbar"],["mat-raised-button","","color","primary",3,"disabled","click"],[1,"loading-block"],[1,"loading-icon"],[1,"no-layers"],[1,"scroll-container"],[1,"scroll"],["class","layer-item",3,"selected",4,"ngFor","ngForOf"],[1,"layer-item"],["mat-icon-button","","color","primary","matTooltip","\u0412\u0438\u0434\u0438\u043c\u043e\u0441\u0442\u044c \u0441\u043b\u043e\u044f \u043d\u0430 \u043a\u0430\u0440\u0442\u0435",3,"disabled","click"],[1,"name",3,"dblclick"],["mat-icon-button","","color","primary","matTooltip","\u0420\u0435\u0434\u0430\u043a\u0442\u0438\u0440\u043e\u0432\u0430\u043d\u0438\u0435 \u043d\u0430\u0438\u043c\u0435\u043d\u043e\u0432\u0430\u043d\u0438\u044f \u0441\u043b\u043e\u044f",3,"disabled","click"],["mat-icon-button","","color","success","matTooltip","\u0421\u043e\u0445\u0440\u0430\u043d\u0438\u0442\u044c \u0438\u0437\u043c\u0435\u043d\u0435\u043d\u0438\u044f",3,"disabled","click"],["mat-icon-button","","color","accent","matTooltip","\u0423\u0434\u0430\u043b\u0438\u0442\u044c \u0441\u043b\u043e\u0439",3,"disabled","click"],["mat-icon-button","","color","primary","matTooltip","\u042d\u043a\u0441\u043f\u043e\u0440\u0442 \u0441\u043b\u043e\u044f \u0432 *.geoJson \u0444\u0430\u0439\u043b",3,"disabled","click"]],template:function(t,o){1&t&&(e.TgZ(0,"div",0)(1,"div",1)(2,"app-yandex-map",2),e.NdJ("objectSelectedEvent",function(i){return o.onObjectSelectedEvent(i)})("objectChangedEvent",function(i){return o.onObjectChangedEvent(i)}),e.qZA()(),e.TgZ(3,"div",3)(4,"div",4),e._uU(5,"\u041c\u0435\u043d\u0435\u0434\u0436\u0435\u0440 \u0441\u043b\u043e\u0435\u0432"),e.qZA(),e.TgZ(6,"div",1),e.YNc(7,j,2,0,"div",5),e.YNc(8,N,2,0,"div",6),e.YNc(9,H,3,1,"div",7),e.qZA(),e.TgZ(10,"div",8)(11,"button",9),e.NdJ("click",function(){return o.onOpenGeoJsonFile()}),e.TgZ(12,"mat-icon"),e._uU(13,"add"),e.qZA(),e.TgZ(14,"span"),e._uU(15,"\u0414\u043e\u0431\u0430\u0432\u0438\u0442\u044c \u0441\u043b\u043e\u0439 \u0438\u0437 *.geoJson \u0444\u0430\u0439\u043b\u0430"),e.qZA()()()()()),2&t&&(e.xp6(2),e.Q6J("layers",o.mapLayers)("editable",!0),e.xp6(5),e.Q6J("ngIf",o.loading),e.xp6(1),e.Q6J("ngIf",!o.loading&&0===o.layers.length),e.xp6(1),e.Q6J("ngIf",!o.loading&&o.layers.length>0),e.xp6(2),e.Q6J("disabled",o.editingMode))},dependencies:[h.sg,h.O5,J.C,w.Hw,b.lW,F.gM],styles:["[_nghost-%COMP%]{display:flex;flex-direction:column;flex:auto}.layers-manager[_ngcontent-%COMP%]{display:flex;width:350px;flex-direction:column;border-left:1px solid #004990}.layers-manager[_ngcontent-%COMP%]   .title[_ngcontent-%COMP%]{text-align:center;font-weight:700;font-size:18px;padding:3px 0;border-bottom:1px solid #004990}.layers-manager[_ngcontent-%COMP%]   .toolbar[_ngcontent-%COMP%]{display:flex;padding:3px 10px;border-top:1px solid #004990;justify-content:center}.no-layers[_ngcontent-%COMP%]{flex:auto;display:flex;flex-direction:column;align-items:center;justify-content:center;color:#e32636}.layer-item[_ngcontent-%COMP%]{display:flex;align-items:center;padding:0 5px}.layer-item[_ngcontent-%COMP%]   .name[_ngcontent-%COMP%]{flex:auto;padding:0 10px}.layer-item[_ngcontent-%COMP%]:hover{background-color:#d6e6fc}.layer-item.selected[_ngcontent-%COMP%]{background-color:#0275d8;color:#fff}.layer-item[_ngcontent-%COMP%]   .mat-icon[_ngcontent-%COMP%]{font-size:22px}.layer-item[_ngcontent-%COMP%]   .mat-icon-button[_ngcontent-%COMP%]{width:26px;height:26px;line-height:1}"]}),a})()}];let $=(()=>{class a{}return a.\u0275fac=function(t){return new(t||a)},a.\u0275mod=e.oAB({type:a}),a.\u0275inj=e.cJS({imports:[h.ez,f.u5,f.UX,T.Bz.forChild(U),M.m,m._R]}),a})()}}]);