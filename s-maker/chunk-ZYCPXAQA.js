import{$b as b,$d as xe,Aa as s,Ac as de,Ae as ye,Ba as h,Be as Fe,Ca as U,Da as z,Ea as I,Ec as me,Ee as g,Fe as Le,Ga as m,Gc as F,Ge as ke,Ha as l,Hc as fe,Ic as Se,Jc as he,M as K,Nd as _e,Od as ve,Pb as O,Qb as ne,Ra as q,Rb as $,Rc as Ce,S as p,Sa as a,Sb as oe,T as d,Ta as j,Tb as J,Ua as Q,Ub as se,Vc as H,W as G,Wa as ee,Wb as ue,Xa as te,Ya as ie,Yd as ge,ab as R,ae as Te,be as Ie,cc as w,ce as Me,da as c,dc as y,ea as u,eb as k,fb as B,fe as Ee,g as W,i as M,ia as T,ic as le,ja as E,jc as ce,nb as N,oa as _,ob as D,oc as ae,oe as je,pe as De,qa as S,rc as pe,se as be,ua as v,ub as re,ue as P,va as X,xa as Y,ya as Z,z as A,za as o,ze as we}from"./chunk-CH7MYQVU.js";import"./chunk-XP2N47VC.js";import"./chunk-XJADAOP3.js";import"./chunk-WDCVTZT5.js";import"./chunk-ZKQ77EQL.js";import"./chunk-Q75QCHGE.js";import"./chunk-JOYMENOW.js";import{i as x}from"./chunk-FY46XAGK.js";function Je(n,f){if(n&1&&(o(0,"div",1),h(1,"mat-spinner"),o(2,"div",2),a(3),s()()),n&2){let e=l();c(3),j(e.processingMessage())}}function He(n,f){if(n&1){let e=I();o(0,"div",13)(1,"div",17),a(2),s(),o(3,"button",18),m("click",function(){let i=p(e).$index,r=l(2);return d(r.onRemoveFile(i))}),o(4,"mat-icon"),a(5,"close"),s()()()}if(n&2){let e=f.$implicit;c(2),j(e.name)}}function Ue(n,f){if(n&1){let e=I();o(0,"div",3)(1,"div",2)(2,"jst-input",4),ie("valueChange",function(i){p(e);let r=l();return te(r.treeName,i)||(r.treeName=i),d(i)}),m("keyUpEvent",function(i){p(e);let r=l();return d(r.onTreeNameKeyUp(i))}),U(3,5),o(4,"button",6)(5,"mat-icon"),a(6,"more_horiz"),s()(),z(),U(7,7),o(8,"mat-icon"),a(9,"info"),s(),o(10,"span"),a(11,"\u0415\u0441\u043B\u0438 \u043D\u0435 \u0443\u043A\u0430\u0437\u0430\u0442\u044C \u0432\u0435\u0442\u043A\u0443, \u0442\u043E \u0431\u0443\u0434\u0435\u0442 \u0438\u0441\u043F\u043E\u043B\u044C\u0437\u043E\u0432\u0430\u043D \u043A\u043E\u0440\u0435\u043D\u044C \u0434\u0435\u0440\u0435\u0432\u0430"),s(),z(),s(),o(12,"jst-tree-menu",8,0),m("itemClickEvent",function(i){p(e);let r=l();return d(r.onItemMenuClick(i))}),s()(),o(14,"div",9),m("JSTFileDropEvent",function(i){p(e);let r=l();return d(r.onFileDrop(i))}),a(15," \u041F\u0435\u0440\u0435\u0442\u0430\u0449\u0438\u0442\u0435 \u0438\u043B\u0438 \u043D\u0430\u0436\u043C\u0438\u0442\u0435 \u0434\u043B\u044F \u0432\u044B\u0431\u043E\u0440\u0430 \u0444\u0430\u0439\u043B\u043E\u0432 "),s(),o(16,"div",10)(17,"div",11)(18,"div",12),Y(19,He,6,1,"div",13,X),s()()()(),o(21,"div",14)(22,"button",15),m("click",function(){p(e);let i=l();return d(i.onGenerate())}),a(23),s(),o(24,"button",16),m("click",function(){p(e);let i=l();return d(i.onClose())}),a(25,"\u0417\u0430\u043A\u0440\u044B\u0442\u044C"),s()()}if(n&2){let e=q(13),t=l();c(2),ee("value",t.treeName),c(2),S("matMenuTriggerFor",e.childMenu),c(8),S("useRouterLink",!1)("items",t.treeMenuList),c(2),S("JSTFileDropMultiFile",!0),c(5),Z(t.fileList()),c(3),S("disabled",t.fileList().length===0),c(),Q(" \u0413\u0435\u043D\u0435\u0440\u0430\u0446\u0438\u044F \u0441\u043F\u0440\u0430\u0439\u0442\u043E\u0432 (",t.fileList().length,") ")}}var Ae=(()=>{class n{constructor(e,t,i,r,C,L){this.treeService=e,this.framesTreeDBService=t,this.spriteFramesService=i,this.framesService=r,this.spritesService=C,this.spriteLayersService=L,this.isProcessing=T(!1),this.processingMessage=T(""),this.fileList=T([]),this.treeMenuList=[],this.treeName="",this.projectId=null,this.treeId=null,this.spriteTreeId=null,this.treeService.setBaseService(this.framesTreeDBService)}ngOnInit(){this.projectId&&this.treeService.fetchTreeList(this.projectId).subscribe(e=>{let t=i=>i.map(r=>({displayName:r.name,children:t(r.children),data:r}));this.treeMenuList=t(e)})}onGenerate(){return x(this,null,function*(){!this.projectId||this.fileList().length===0||(this.processingMessage.set("\u0413\u0435\u043D\u0435\u0440\u0430\u0446\u0438\u044F \u0441\u043F\u0440\u0430\u0439\u0442\u043E\u0432..."),this.isProcessing.set(!0),yield this.generateSprites(),this.dialogRef?.close({isOK:!0}))})}onRemoveFile(e){this.fileList.update(t=>(t.splice(e,1),[...t]))}onFileDrop(e){this.fileList.set(e)}onItemMenuClick(e){this.treeName=e.displayName,this.treeId=e.data.id}setData(e){this.projectId=e.projectId??null,this.spriteTreeId=e.spriteTreeId??null}onTreeNameKeyUp(e){["ArrowLeft","ArrowRight","ArrowUp","ArrowDown","Escape","ShiftRight","ShiftLeft","ControlLeft","ControlRight"].includes(e.code)||(this.treeId=null)}onClose(){this.dialogRef?.close()}generateSprites(){return x(this,null,function*(){if(!this.projectId||this.fileList().length===0)return;if(!this.treeId)if(!this.treeName)this.treeId=null;else{let i=yield M(this.framesTreeDBService.insert({projectId:this.projectId,parentId:null,name:this.treeName}));i&&(this.treeId=i.id)}let e=this.fileList().length,t=1;for(let i of this.fileList())this.processingMessage.set(`\u0413\u0435\u043D\u0435\u0440\u0430\u0446\u0438\u044F \u0441\u043F\u0440\u0430\u0439\u0442\u043E\u0432 (${t} \u0438\u0437 ${e})...`),t++,yield this.createSprite(i,this.treeId)})}createSprite(e,t){return x(this,null,function*(){if(!this.projectId)return;let i=yield M(this.framesService.add(this.projectId,t,e)),r=yield M(this.spritesService.insert({projectId:this.projectId,treeId:this.spriteTreeId,name:e.name,width:i.width,height:i.height,bgColor:null,groundPointX:null,groundPointY:null,visibleGroundPoint:!1})),C=yield M(this.spriteLayersService.insert({projectId:this.projectId,spriteId:r.id,name:"def",visible:!0,x:0,y:0,zIndex:0,bgColor:null,flipHorizontal:!1,flipVertical:!1}));yield M(this.spriteFramesService.insert({projectId:this.projectId,spriteId:r.id,layerId:C.id,frameId:i.id,name:"Frame 1",x:0,y:0,width:i.width,height:i.height,visible:!0}))})}static{this.\u0275fac=function(t){return new(t||n)(u(g),u(ae),u(pe),u(de),u(F),u(me))}}static{this.\u0275cmp=E({type:n,selectors:[["sc-sprite-multi-create-list"]],features:[R([g])],decls:2,vars:1,consts:[["treeMenu",""],[1,"loading-container"],[1,"mt-10"],[1,"jst-modal-container","flex-col","padding-10"],["label","\u0412\u044B\u0431\u0435\u0440\u0438\u0442\u0435 \u0438\u043B\u0438 \u0443\u043A\u0430\u0436\u0438\u0442\u0435 \u043D\u043E\u0432\u0443\u044E \u0432\u0435\u0442\u043A\u0443 \u0434\u0435\u0440\u0435\u0432\u0430 \u043A\u043E\u043B\u043B\u0435\u043A\u0446\u0438\u0438 \u0444\u0440\u0435\u0439\u043C\u043E\u0432",3,"valueChange","keyUpEvent","value"],["JSTIconPrefix",""],["mat-icon-button","","color","primary",3,"matMenuTriggerFor"],["JSTHint",""],[3,"itemClickEvent","useRouterLink","items"],["JSTFileDrop","","JSTFileDropClickChoice","click",1,"file-drop",3,"JSTFileDropEvent","JSTFileDropMultiFile"],[1,"filelist"],[1,"scroll-container"],[1,"scroll"],[1,"filelist-item"],[1,"jst-modal-footer-buttons"],["mat-raised-button","","color","primary",3,"click","disabled"],["mat-raised-button","","color","accent",3,"click"],[1,"filelist-item__name"],["mat-icon-button","","color","accent",3,"click"]],template:function(t,i){t&1&&_(0,Je,4,1,"div",1)(1,Ue,26,7),t&2&&v(i.isProcessing()?0:1)},dependencies:[D,$,O,ne,y,w,J,oe,ve,_e,Me,ge,xe,Ie,De,je,Te],styles:["[_nghost-%COMP%]{display:flex;flex-direction:column;flex:auto;width:750px;height:450px}.file-drop[_ngcontent-%COMP%]{text-align:center;padding:15px;margin-top:15px;cursor:default;border:1px dashed rgb(229,229,229);-webkit-user-select:none;user-select:none}.file-drop.jst-file-drop-hover[_ngcontent-%COMP%]{border-color:#00c851}.filelist[_ngcontent-%COMP%]{display:flex;flex-direction:column;flex:auto;margin-top:15px}.filelist[_ngcontent-%COMP%]   .filelist-item[_ngcontent-%COMP%]{display:flex}.filelist[_ngcontent-%COMP%]   .filelist-item[_ngcontent-%COMP%]   .filelist-item__name[_ngcontent-%COMP%]{flex:auto}"],changeDetection:0})}}return n})();function Ge(n,f){n&1&&(o(0,"div",4),h(1,"mat-spinner"),s())}function Xe(n,f){if(n&1){let e=I();o(0,"smc-tiles-list",6),m("removeEvent",function(i){p(e);let r=l();return d(r.onRemove(i))})("downloadEvent",function(i){p(e);let r=l();return d(r.onDownload(i))})("clickEvent",function(i){p(e);let r=l();return d(r.onClickTile(i))})("dragEndEvent",function(i){p(e);let r=l();return d(r.onDragEndTile(i))}),s(),o(1,"div",7)(2,"span"),a(3," \u0412\u0441\u0435\u0433\u043E: "),o(4,"strong"),a(5),s()()()}if(n&2){let e=l();S("visibleUsed",!1)("visibleDownload",!0)("visibleRemove",!0)("tiles",e.tiles()),c(5),j(e.tiles().length)}}function Ye(n,f){n&1&&(o(0,"div",5),a(1,"\u041D\u0435\u0442 \u0434\u0430\u043D\u043D\u044B\u0445"),s())}var Re=(()=>{class n{constructor(e,t,i,r,C,L){this.router=e,this.jstDialogService=t,this.treeStore=i,this.spritesService=r,this.exportSpriteService=C,this.importSpriteService=L,this.selectedNode$=this.treeStore.selectedNode$,this.isLoading=T(!1),this.tiles=T([]),this.currentTreeId=null,this.destroyRef$=K(G)}ngOnInit(){this.treeStore.selectedNode$.pipe(b(this.destroyRef$)).subscribe(e=>{this.currentTreeId=e?.id??null,this.fetchTiles()})}onDownload(e){return x(this,null,function*(){this.jstDialogService.showWait("\u0413\u0435\u043D\u0435\u0440\u0430\u0446\u0438\u044F SpritePack..."),W(this.exportSpriteService.exportSpritePack(e.id)).pipe(A(()=>this.jstDialogService.hideWait())).subscribe({next:()=>this.jstDialogService.showToastSuccess("\u0410\u0440\u0445\u0438\u0432 \u0433\u043E\u0442\u043E\u0432 \u0438 \u043E\u0442\u043F\u0440\u0430\u0432\u043B\u0435\u043D \u043D\u0430 \u0441\u043A\u0430\u0447\u0438\u0432\u0430\u043D\u0438\u0435"),error:t=>this.jstDialogService.showToastError(t.message)})})}onImport(){this.projectId&&le.uploadFile(".zip").subscribe(e=>{this.jstDialogService.showWait("\u0418\u043C\u043F\u043E\u0440\u0442 \u0441\u043F\u0440\u0430\u0439\u0442\u0430...");let t=new FileReader;t.onload=i=>x(this,null,function*(){if(i.target?.result)try{yield this.importSpriteService.importSpriteZip(Number(this.projectId),this.currentTreeId,i.target.result),this.jstDialogService.hideWait(),this.jstDialogService.showToastSuccess("\u0418\u043C\u043F\u043E\u0440\u0442 \u0441\u043F\u0440\u0430\u0439\u0442\u0430 \u043F\u0440\u043E\u0448\u0435\u043B \u0443\u0441\u043F\u0435\u0448\u043D\u043E"),this.fetchTiles()}catch(r){this.jstDialogService.showToastError(r.message)}}),t.onerror=()=>this.jstDialogService.showToastError("\u041E\u0448\u0438\u0431\u043A\u0430 \u0447\u0442\u0435\u043D\u0438\u044F \u0430\u0440\u0445\u0438\u0432\u0430"),t.readAsArrayBuffer(e)})}onMultiAdd(){ce.blurActiveElement(),this.projectId&&this.jstDialogService.showModal("\u041C\u0443\u043B\u044C\u0442\u0438\u0441\u043E\u0437\u0434\u0430\u043D\u0438\u0435 \u043F\u0440\u043E\u0441\u0442\u044B\u0445 \u0441\u043F\u0440\u0430\u0439\u0442\u043E\u0432",Ae,{projectId:this.projectId,spriteTreeId:this.currentTreeId},!0).subscribe(e=>{e?.isOK&&this.fetchTiles()})}onClickTile(e){this.router.navigate([this.projectId,P.code,e.id])}onDragEndTile(e){this.tiles.update(t=>{let i=t.findIndex(r=>r.id===e);return i>=0&&t.splice(i,1),t})}onRemove(e){this.jstDialogService.showConfirm("\u0412\u044B \u0434\u0435\u0439\u0441\u0442\u0432\u0438\u0442\u0435\u043B\u044C\u043D\u043E \u0445\u043E\u0442\u0438\u0442\u0435 \u0443\u0434\u0430\u043B\u0438\u0442\u044C \u044D\u0442\u043E\u0442 \u0441\u043F\u0440\u0430\u0439\u0442?").subscribe(t=>{t&&(this.isLoading.set(!0),this.spritesService.remove(e.id).pipe(A(()=>this.isLoading.set(!1))).subscribe(()=>{this.tiles.update(i=>{let r=i.findIndex(C=>C.id===e.id);return r>=0&&i.splice(r,1),i})}))})}onAdd(){this.jstDialogService.showModal("\u041D\u043E\u0432\u044B\u0439 \u0441\u043F\u0440\u0430\u0439\u0442",ye,{label:"\u041D\u0430\u0438\u043C\u0435\u043D\u043E\u0432\u0430\u043D\u0438\u0435 \u0441\u043F\u0440\u0430\u0439\u0442\u0430",applyTitle:"\u0414\u043E\u0431\u0430\u0432\u0438\u0442\u044C \u0441\u043F\u0440\u0430\u0439\u0442"}).subscribe(e=>{e!==void 0&&this.spritesService.add(this.projectId,this.currentTreeId,e).subscribe(t=>{this.router.navigate([this.projectId,P.code,t.id])})})}fetchTiles(){this.spritesService.fetchTiles(this.projectId,this.currentTreeId).pipe(b(this.destroyRef$),A(()=>this.isLoading.set(!1))).subscribe(e=>{this.tiles.set(e)})}static{this.\u0275fac=function(t){return new(t||n)(u(ue),u(Ee),u(H),u(F),u(fe),u(he))}}static{this.\u0275cmp=E({type:n,selectors:[["sc-sprites-list"]],inputs:{projectId:"projectId"},decls:16,vars:5,consts:[[1,"flex-row-align-center","border-bottom"],["mat-button","","color","primary",1,"ml-10",3,"click"],[1,"ml-10","v-divider"],[1,"tree-title"],[1,"loading-container"],[1,"empty-message"],["backgroundIcon","edit",3,"removeEvent","downloadEvent","clickEvent","dragEndEvent","visibleUsed","visibleDownload","visibleRemove","tiles"],[1,"statusbar"]],template:function(t,i){if(t&1&&(o(0,"div",0)(1,"button",1),m("click",function(){return i.onAdd()}),a(2,"\u0421\u043E\u0437\u0434\u0430\u0442\u044C \u0441\u043F\u0440\u0430\u0439\u0442"),s(),h(3,"div",2),o(4,"button",1),m("click",function(){return i.onImport()}),a(5,"\u0418\u043C\u043F\u043E\u0440\u0442\u0438\u0440\u043E\u0432\u0430\u0442\u044C \u0441\u043F\u0440\u0430\u0439\u0442"),s(),h(6,"div",2),o(7,"button",1),m("click",function(){return i.onMultiAdd()}),a(8,"\u041C\u0443\u043B\u044C\u0442\u0438\u0441\u043E\u0437\u0434\u0430\u043D\u0438\u0435 \u043F\u0440\u043E\u0441\u0442\u044B\u0445 \u0441\u043F\u0440\u0430\u0439\u0442\u043E\u0432"),s(),o(9,"div",3)(10,"span"),a(11),k(12,"async"),s()()(),_(13,Ge,2,0,"div",4)(14,Xe,6,5)(15,Ye,2,0,"div",5)),t&2){let r;c(11),j((r=(r=B(12,3,i.selectedNode$))==null?null:r.name)!==null&&r!==void 0?r:"\u041A\u043E\u0440\u0435\u043D\u044C \u0434\u0435\u0440\u0435\u0432\u0430"),c(2),v(i.isLoading()?13:-1),c(),v(i.tiles().length>0?14:15)}},dependencies:[D,N,$,O,J,y,w,Le],styles:["[_nghost-%COMP%]{position:relative;flex:auto;display:flex;flex-direction:column}.tree-title[_ngcontent-%COMP%]{flex:auto;text-align:right;padding-right:10px}.statusbar[_ngcontent-%COMP%]{font-size:12px;padding:5px 10px;border-top:1px solid rgb(229,229,229)}"],changeDetection:0})}}return n})();function Ze(n,f){n&1&&(o(0,"div",0),h(1,"mat-spinner"),s())}function qe(n,f){if(n&1){let e=I();h(0,"smc-header",1),o(1,"div",2)(2,"div",3)(3,"smc-tree",4),m("dropToNodeEvent",function(i){p(e);let r=l(2);return d(r.onSpriteToTreeNode(i))}),s()(),o(4,"div",5),h(5,"sc-sprites-list",6),s()()}if(n&2){let e=f,t=l(2);S("project",e)("currentModule",t.currentModule),c(3),S("projectId",e.id),c(2),S("projectId",e.id)}}function Qe(n,f){n&1&&h(0,"smc-page-not-found")}function et(n,f){if(n&1&&(_(0,qe,6,4),k(1,"async"),_(2,Qe,1,0,"smc-page-not-found")),n&2){let e,t=l();v((e=B(1,1,t.project$))?0:2,e)}}var Ht=(()=>{class n{constructor(e,t,i,r,C,L){this.titleService=e,this.activatedRoute=t,this.projectStore=i,this.treeService=r,this.spritesTreeDBService=C,this.spritesService=L,this.currentModule=P,this.isInitializing=this.projectStore.isInitializing$,this.project$=this.projectStore.project$,this.activatedRoute.paramMap.pipe(b()).subscribe(V=>{this.projectStore.initialize(V.get("pid"))}),this.project$.pipe(b()).subscribe(V=>{V&&this.titleService.setTitle(`${this.currentModule.name} | ${V.name??""} | ${be}`)}),this.treeService.setBaseService(this.spritesTreeDBService)}onSpriteToTreeNode(e){this.spritesService.update(e.id,{treeId:e.treeId}).subscribe()}static{this.\u0275fac=function(t){return new(t||n)(u(re),u(se),u(Ce),u(g),u(Se),u(F))}}static{this.\u0275cmp=E({type:n,selectors:[["sc-home"]],features:[R([g,H])],decls:3,vars:3,consts:[[1,"flex-auto","flex-row-centered"],[3,"project","currentModule"],[1,"flex-auto","flex-row"],[1,"flex-col","w-350","border-right"],["treeStorageKey","sc-tree-selected","askRemoveTree","\u0412\u044B \u0434\u0435\u0439\u0441\u0442\u0432\u0438\u0442\u0435\u043B\u044C\u043D\u043E \u0445\u043E\u0442\u0438\u0442\u0435 \u0443\u0434\u0430\u043B\u0438\u0442\u044C \u044D\u0442\u0443 \u0432\u0435\u0442\u043A\u0443 \u0438 \u0435\u0435 \u043F\u043E\u0442\u043E\u043C\u043A\u043E\u0432?<br>\u041F\u0440\u0438 \u044D\u0442\u043E\u043C \u0443\u0434\u0430\u043B\u044F\u0442\u0441\u044F \u0432\u0441\u0435 \u0441\u0432\u044F\u0437\u0430\u043D\u043D\u044B\u043C\u0438 \u0441 \u043D\u0438\u043C\u0438 \u0441\u043F\u0440\u0430\u0439\u0442\u044B",3,"dropToNodeEvent","projectId"],[1,"flex-col","flex-auto"],[3,"projectId"]],template:function(t,i){t&1&&(_(0,Ze,2,0,"div",0),k(1,"async"),_(2,et,3,3)),t&2&&v(B(1,1,i.isInitializing)?0:2)},dependencies:[D,N,y,w,we,Fe,ke,Re],styles:["[_nghost-%COMP%]{flex:auto;display:flex;flex-direction:column}"],changeDetection:0})}}return n})();export{Ht as SCHomeComponent};
